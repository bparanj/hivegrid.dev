Create a cron playbook, cron_job.yml inside ansible/playbooks/maintain:

```yml
- name: Setup a cron job to print the timestamp every midnight
  hosts: all
  become: yes # Use sudo to manage cron jobs
  tasks:
    - name: Ensure cron is installed (Ubuntu)
      ansible.builtin.apt:
        name: cron
        state: present

    - name: Schedule cron job to print the timestamp at midnight
      ansible.builtin.cron:
        name: "Print timestamp"
        job: "date \"+\\%F \\%T\" >> /var/log/timestamp.log"
        minute: "0"
        hour: "0"
        day: "*"
        month: "*"
        weekday: "*"
        user: root
        state: present
```

From the ansible folder, run the playbook:

```sh
ansible-playbook  playbooks/maintain/cron_job.yml -i inventory.ini
```

View the crontab for the root user:

```
ubuntu@ip-10-0-10-4:~$ sudo crontab -l -u root
#Ansible: Print timestamp
0 0 * * * date "+\%F \%T" >> /var/log/timestamp.log
```

Verify that /var/log/timestamp.log has timestamp to make sure CRON is setup correctly.

```
cat /var/log/timestamp.log
```

Output:

```
2024-04-29 00:00:01
```

Database backup:

```yml
- hosts: all
  become: yes
  become_user: root
  become_method: sudo
  become_flags: '-i'  # This helps in some cases where the environment needs to be cleaner

  vars:
    backup_dir: /var/backups/postgres

  tasks:
    - name: Ensure cron is installed (Ubuntu)
      ansible.builtin.apt:
        name: cron
        state: present

    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        owner: postgres
        group: postgres
        mode: '0755'

    - name: Create a CRON job for PostgreSQL backup
      cron:
        name: "Backup PostgreSQL database every midnight"
        minute: "0"
        hour: "0"
        job: >
          /usr/bin/pg_dump -U {{ db_user }} -Fc {{ db_name }} > {{ backup_dir }}/{{ db_name }}_`date +\%Y-\%m-\%d_\%H-\%M-\%S`.dump
        state: present
        user: postgres

    - name: Set PostgreSQL user password
      postgresql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
      become_user: postgres
```

```
ansible-playbook playbooks/maintain/backup-db.yml -e "db_user=your_db_user db_password=your_db_password db_name=your_db_name"
```

ansible-playbook playbooks/maintain/backup-db.yml -e "db_user=deploy db_password=password db_name=capt_production"

ansible-galaxy install ome.postgresql_backup


---
- hosts: all
  become: yes

  vars:
    postgresql_backup_dir: "/var/backups/postgres"
    postgresql_backup_database: "{{ db_name }}"
    postgresql_backup_username: "{{ db_user }}"
    postgresql_backup_password: "{{ db_password }}"

  roles:
    - ome.postgresql_backup


ansible-playbook -i inventory.ini playbooks/maintain/backup-db.yml -e "postgresql_backup_username=deploy postgresql_backup_password=password db_name=capt_production"

Check if cron is setup correctly:

sudo crontab -l -u postgres


sudo ls -l /var/backups/postgres


Yes, the cron job syntax you've posted is generally correct for what you're trying to accomplish, which is to take a backup of the `capt_production` database using `pg_dump` every day at midnight. However, there's a small modification needed to correctly handle the output redirection in a cron environment.

### Corrected Command:

Here's the command with the necessary correction:

```bash
0 0 * * * /usr/bin/pg_dump -U deploy -Fc capt_production > /var/backups/postgres/capt_production_$(date +\%Y-\%m-\%d_\%H-\%M-\%S).dump
```

### Key Changes:

1. **Use `$(...)` for Command Substitution**: It's better to use `$(...)` for command substitution instead of backticks `` `...` ``. Itâ€™s more modern and allows for nesting, which can be useful in more complex scenarios.

2. **Escaping Percent Signs**: You correctly escaped the percent signs (`%`) as `\%`, which is necessary in cron jobs because unescaped percent signs are treated as newline characters.

### Explanation of Each Part:

- `0 0 * * *`: This specifies when the cron job runs. `0 0 * * *` means it runs at 0 minutes and 0 hours of every day of every month, effectively midnight each day.
- `/usr/bin/pg_dump`: This is the path to the `pg_dump` command, which is used for taking backups of PostgreSQL databases.
- `-U deploy`: This option specifies the username `deploy` to connect to the PostgreSQL database.
- `-Fc`: This option tells `pg_dump` to use the custom format for the backup file, which is more flexible and robust than plain SQL dumps.
- `> /var/backups/postgres/capt_production_$(date +\%Y-\%m-\%d_\%H-\%M-\%S).dump`: This redirects the output of the `pg_dump` command to a file. The filename includes a timestamp to ensure it's unique and provides an easy way to identify when the backup was taken.

Make sure the `postgres` user or the user under which the cron job runs has the appropriate permissions to write to the `/var/backups/postgres/` directory. Also, ensure that the `deploy` user has access to perform the `pg_dump` on the `capt_production` database. If any authentication errors arise, you may need to check the PostgreSQL user permissions or the `pg_hba.conf` configuration.


